version: '3'

services:
  broker:
    container_name: mqtt-broker
    restart: always
    image: "eclipse-mosquitto"
    expose:
      - "1883/tcp"
      - "9001/tcp"
    volumes:
      - ${SERVER_DIR}/docker/mqtt-broker/config:/mosquitto/config/
      - ${SERVER_DIR}/docker/mqtt-broker/data:/mosquitto/data/
      - ${SERVER_DIR}/docker/mqtt-broker/auth:/mosquitto/auth/

  mongodb:
    container_name: mongodb
    restart: always
    image: "mongo"
    expose:
      - "27017/tcp"
    volumes:
      - /data/db:/data/db

  redis:
    container_name: redis
    restart: always
    image: "redis:alpine"
    expose:
      - "6379/tcp"

  collector:
    build: ./mqtt-subs
    container_name: collector
    restart: always
    image: "ardikabs/collector"
    links:
      - mongodb
      - broker
    depends_on:
      - mongodb
      - broker
    volumes:
      - ${SERVER_DIR}/docker/mqtt-subs/collector:/collector

  reverseproxy:
    build: ./nginx
    container_name: reverseproxy
    restart: always
    image: "ardikabs/reverse-proxy"
    links:
      - serverapp
      - mongodb
      - fluentd
      - fluentd-node1
      - fluentd-node2
    depends_on:
      - mongodb
      - serverapp
      - fluentd
      - fluentd-node1
      - fluentd-node2

    ports:
      - "80:80"
      - "27020:27020/tcp"
      - "24224:24224/tcp"
      - "24224:24224/udp"
    volumes:
      - ${SERVER_DIR}/docker/nginx/log:/var/log/nginx/

  serverapp:
    build: ./server
    container_name: serverapp
    restart: always
    image: "ardikabs/fipro-server:1.1"
    expose:
      - "27017/tcp"
    links:
      - mongodb
      - redis
    depends_on:
      - mongodb
      - redis
    volumes:
      - ${SERVER_DIR}/docker/server/project:/project
  

  fluentd:
    build: ./fluentd
    container_name: aggregator-master
    restart: always
    image: "ardikabs/fluentd:1.1"
    links:
      - broker
      - mongodb
    depends_on:
      - broker
      - collector
      - mongodb
    expose:
      - "24224/tcp"
      - "24224/udp"
    volumes:
      - ${SERVER_DIR}/docker/fluentd/conf:/fluentd/etc
      - ${SERVER_DIR}/docker/fluentd/geoip:/fluentd/geoip

  fluentd-node1:
    build: ./fluentd
    container_name: aggregator-node1
    restart: always
    image: "ardikabs/fluentd:1.1"
    links:
      - broker
      - mongodb
    depends_on:
      - broker
      - collector
      - mongodb
    expose:
      - "24224/tcp"
      - "24224/udp"
    volumes:
      - ${SERVER_DIR}/docker/fluentd/conf-node1:/fluentd/etc
      - ${SERVER_DIR}/docker/fluentd/geoip:/fluentd/geoip  

  fluentd-node2:
    build: ./fluentd
    container_name: aggregator-node2
    restart: always
    image: "ardikabs/fluentd:1.1"
    links:
      - broker
      - mongodb
    depends_on:
      - broker
      - collector
      - mongodb
    expose:
      - "24224/tcp"
      - "24224/udp"
    volumes:
      - ${SERVER_DIR}/docker/fluentd/conf-node2:/fluentd/etc
      - ${SERVER_DIR}/docker/fluentd/geoip:/fluentd/geoip
      
  