<source>
 @log_level fatal
 @type forward
 bind 0.0.0.0
 port 24224
</source>

<filter honeypot.**>
    @type record_modifier

    char_encoding utf-8
</filter>

<filter honeypot.dionaea>
    @type record_modifier
    <record>
        credentials ${if record.has_key?("credentials"); record["username"] = record["credentials"]["username"][0]; record["password"] = record["credentials"]["password"][0] ;end;nil}
        ; credentials ${if record.has_key?("credentials"); record["username"] = record["credentials"][0]["username"]; record["password"] = record["credentials"][0]["password"] ;end;nil}
        _dummy_ ${if record["src_ip"].include?('::ffff:'); record["src_ip"] = record["src_ip"].gsub("::ffff:","");end; if record["dst_ip"].include?("::ffff:"); record["dst_ip"] = record["dst_ip"].gsub("::ffff:","")  ;end;nil}
    </record>
    remove_keys credentials, _dummy_

</filter>

<filter honeypot.cowrie>
    @type record_modifier
    remove_keys _dummy_
    <record>
        _dummy_ ${if record["dst_port"] == 2222; record["dst_port"] = 22;elsif record["dst_port"] == 2223; record["dst_port"] = 23;end;nil}
    </record>
</filter>


<match honeypot.**>

    @type copy

    <store>
        @type stdout
    </store>

    # <store>
    #     @type mongo

    #     host mongodb
    #     port 27017

    #     capped
    #     capped_size 100m

    #     database fipro
    #     collection raw_log

    #     flush_interval 1s

    #     include_time_key true
    #     time_key timestamp
    # </store>

    <store>
    @type mqtt
    
    host mqtt-broker
    port 1883      
    client_id FLUENTD.HoneypotPublisher

    <security>
        username fluentd
        password rustygear125
    </security>

    keep_alive 15s

    <format>
        @type json
        add_newline false
    </format>
    <inject>
        time_key timestamp
    </inject>
    <buffer>
        flush_interval 1s
    </buffer>
    </store>

</match>